<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard RH â€” Custo da ForÃ§a de Trabalho</title>

  <!-- Bootstrap (layout rÃ¡pido) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.8/css/dataTables.bootstrap5.min.css">
  <style>
    body { background:#f6f7fb; }
    .card { border:0; border-radius:16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    .kpi { font-weight:700; font-size:1.35rem; }
    .muted { color:#6c757d; }
    .badge-soft { background: rgba(13,110,253,.10); color:#0d6efd; }
    .smallcaps { font-variant: all-small-caps; letter-spacing:.06em; color:#6c757d; }
    canvas { max-height: 340px; }
    .table-wrap { overflow-x:auto; }
    .sticky-topbar { position: sticky; top: 0; z-index: 1020; background: #f6f7fb; padding-top: .75rem; padding-bottom: .75rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
<div class="container-fluid px-3 px-md-4">
  <div class="sticky-topbar">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <h3 class="mb-0">Dashboard RH â€” Custo da ForÃ§a de Trabalho</h3>
        <div class="muted">Carregue um CSV (separador <span class="mono">;</span>) e analise custos, encargos e benefÃ­cios.</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <input type="file" id="fileInput" class="form-control" accept=".csv,text/csv" style="max-width: 340px;">
        <button id="btnLoadSample" class="btn btn-outline-secondary">Carregar Ãºltimo arquivo</button>
        <button id="btnDownload" class="btn btn-primary">Baixar CSV (com transporte)</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mt-1">
    <div class="col-12 col-md-3">
      <div class="card p-3">
        <div class="smallcaps">Headcount</div>
        <div class="kpi" id="kpiHeadcount">â€”</div>
        <div class="muted"><span class="badge badge-soft rounded-pill" id="kpiSplit">â€”</span></div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card p-3">
        <div class="smallcaps">Custo Total (mÃªs)</div>
        <div class="kpi" id="kpiTotalCost">â€”</div>
        <div class="muted">MÃ©dia por pessoa: <span class="mono" id="kpiAvgCost">â€”</span></div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card p-3">
        <div class="smallcaps">Encargos (empresa)</div>
        <div class="kpi" id="kpiEncargos">â€”</div>
        <div class="muted">% sobre bruto: <span class="mono" id="kpiEncargosPct">â€”</span></div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card p-3">
        <div class="smallcaps">BenefÃ­cios</div>
        <div class="kpi" id="kpiBeneficios">â€”</div>
        <div class="muted">Inclui Transporte (se preenchido)</div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3 mt-1">
    <div class="col-12 col-lg-4">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="smallcaps">ComposiÃ§Ã£o do headcount</div>
            <div class="muted">CLT vs EstÃ¡gio</div>
          </div>
        </div>
        <canvas id="chartHeadcount"></canvas>
      </div>
    </div>
    <div class="col-12 col-lg-8">
      <div class="card p-3">
        <div class="smallcaps">ComposiÃ§Ã£o do custo</div>
        <div class="muted">Bruto + Encargos + BenefÃ­cios</div>
        <canvas id="chartCostBreakdown"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12">
      <div class="card p-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <div class="smallcaps">Maiores custos por colaborador</div>
            <div class="muted">Top 10 por custo total</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label class="muted">Top</label>
            <select id="selTopN" class="form-select form-select-sm" style="width:90px">
              <option>5</option>
              <option selected>10</option>
              <option>15</option>
              <option>20</option>
            </select>
          </div>
        </div>
        <canvas id="chartTopCosts"></canvas>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="row g-3 mt-1 mb-4">
    <div class="col-12">
      <div class="card p-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <div class="smallcaps">Tabela detalhada</div>
            <div class="muted">Edite transporte diretamente na tabela e recalcule o custo.</div>
          </div>
          <button id="btnRecalc" class="btn btn-outline-primary btn-sm">Recalcular totais</button>
        </div>

        <div class="table-wrap mt-2">
          <table id="tbl" class="table table-striped table-hover table-sm align-middle" style="width:100%">
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>VÃ­nculo</th>
                <th class="text-end">Bruto</th>
                <th class="text-end">FGTS</th>
                <th class="text-end">INSS Empresa</th>
                <th class="text-end">RAT</th>
                <th class="text-end">Terceiros</th>
                <th class="text-end">AlimentaÃ§Ã£o</th>
                <th class="text-end">Unimed</th>
                <th class="text-end">Transporte</th>
                <th class="text-end">Custo Total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="muted mt-2">
          <span class="badge badge-soft rounded-pill">Dica</span>
          Para atualizar o dashboard no futuro, basta importar um novo CSV (mesma estrutura de colunas). O dashboard salva o Ãºltimo arquivo no navegador.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
  // ---------- Helpers ----------
  const fmtBRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });

  function parseNumber(v){
    if (v === null || v === undefined) return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    let s = String(v).trim();
    if (!s) return 0;
    // remove thousands separators (.)
    s = s.replace(/\./g, '');
    // decimal comma -> dot
    s = s.replace(',', '.');
    // remove spaces
    s = s.replace(/\s+/g, '');
    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  function toBRL(n){ return fmtBRL.format(n || 0); }

  function computeRowCost(r){
    const bruto = parseNumber(r['Bruto MÃªs']);
    const fgts = parseNumber(r['FGTS']);
    const inss = parseNumber(r['INSS Empresa']);
    const rat  = parseNumber(r['RAT']);
    const terc = parseNumber(r['Terceiros']);
    const alim = parseNumber(r['AlimentaÃ§Ã£o']);
    const uni  = parseNumber(r['Unimed']);
    const transp = parseNumber(r['Transporte']);
    const total = bruto + fgts + inss + rat + terc + alim + uni + transp;
    r['_custo_total_calc'] = total;
    return total;
  }

  // ---------- State ----------
  let rawRows = [];
  let chart1, chart2, chart3;
  let dt;

  function saveLastCsv(text){
    try { localStorage.setItem('rh_dashboard_last_csv', text); } catch(e){}
  }
  function loadLastCsv(){
    try { return localStorage.getItem('rh_dashboard_last_csv'); } catch(e){ return null; }
  }

  // ---------- Render ----------
  function renderAll(){
    if (!rawRows.length) return;

    // compute costs
    rawRows.forEach(r => computeRowCost(r));

    // KPIs
    const headcount = rawRows.length;
    const byVinc = rawRows.reduce((acc,r)=>{
      const k=(r['VÃ­nculo']||'').trim()||'â€”';
      acc[k]=(acc[k]||0)+1;
      return acc;
    }, {});
    const totalCost = rawRows.reduce((s,r)=> s + (r['_custo_total_calc']||0), 0);
    const totalBruto = rawRows.reduce((s,r)=> s + parseNumber(r['Bruto MÃªs']), 0);
    const totalEnc = rawRows.reduce((s,r)=> s + parseNumber(r['FGTS']) + parseNumber(r['INSS Empresa']) + parseNumber(r['RAT']) + parseNumber(r['Terceiros']), 0);
    const totalBen = rawRows.reduce((s,r)=> s + parseNumber(r['AlimentaÃ§Ã£o']) + parseNumber(r['Unimed']) + parseNumber(r['Transporte']), 0);

    document.getElementById('kpiHeadcount').textContent = headcount;
    const splitTxt = Object.entries(byVinc).map(([k,v])=>`${k}: ${v}`).join(' | ');
    document.getElementById('kpiSplit').textContent = splitTxt || 'â€”';

    document.getElementById('kpiTotalCost').textContent = toBRL(totalCost);
    document.getElementById('kpiAvgCost').textContent = toBRL(totalCost / Math.max(headcount,1));

    document.getElementById('kpiEncargos').textContent = toBRL(totalEnc);
    document.getElementById('kpiEncargosPct').textContent =
      (totalBruto > 0 ? ((totalEnc/totalBruto)*100).toFixed(2) : '0.00') + '%';

    document.getElementById('kpiBeneficios').textContent = toBRL(totalBen);

    // Charts
    renderCharts(byVinc, totalBruto, totalEnc, totalBen);
    renderTopCosts();
    renderTable();
  }

  function renderCharts(byVinc, totalBruto, totalEnc, totalBen){
    // Headcount pie
    const labels = Object.keys(byVinc);
    const values = Object.values(byVinc);

    const ctx1 = document.getElementById('chartHeadcount');
    if (chart1) chart1.destroy();
    chart1 = new Chart(ctx1, {
      type: 'pie',
      data: { labels, datasets: [{ data: values }] },
      options: { plugins:{ legend:{ position:'bottom' } } }
    });

    // Cost breakdown bar
    const ctx2 = document.getElementById('chartCostBreakdown');
    if (chart2) chart2.destroy();
    chart2 = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: ['Bruto', 'Encargos', 'BenefÃ­cios'],
        datasets: [{ label:'R$ (mÃªs)', data: [totalBruto, totalEnc, totalBen] }]
      },
      options: {
        plugins:{ legend:{ display:false } },
        scales:{ y:{ ticks:{ callback:(v)=> fmtBRL.format(v) } } }
      }
    });
  }

  function renderTopCosts(){
    const topN = parseInt(document.getElementById('selTopN').value, 10) || 10;
    const sorted = [...rawRows]
      .sort((a,b)=> (b._custo_total_calc||0) - (a._custo_total_calc||0))
      .slice(0, topN);

    const labels = sorted.map(r => r['Colaborador']);
    const values = sorted.map(r => r._custo_total_calc||0);

    const ctx3 = document.getElementById('chartTopCosts');
    if (chart3) chart3.destroy();
    chart3 = new Chart(ctx3, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Custo Total', data: values }] },
      options: {
        indexAxis: 'y',
        plugins:{ legend:{ display:false } },
        scales:{ x:{ ticks:{ callback:(v)=> fmtBRL.format(v) } } }
      }
    });
  }

  function renderTable(){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    for (const r of rawRows){
      const tr = document.createElement('tr');

      const cells = [
        r['Colaborador'] ?? '',
        r['VÃ­nculo'] ?? '',
        toBRL(parseNumber(r['Bruto MÃªs'])),
        toBRL(parseNumber(r['FGTS'])),
        toBRL(parseNumber(r['INSS Empresa'])),
        toBRL(parseNumber(r['RAT'])),
        toBRL(parseNumber(r['Terceiros'])),
        toBRL(parseNumber(r['AlimentaÃ§Ã£o'])),
        toBRL(parseNumber(r['Unimed'])),
        '', // Transporte editable
        toBRL(r['_custo_total_calc']||0),
      ];

      cells.forEach((val, idx)=>{
        const td = document.createElement('td');
        if (idx>=2) td.classList.add('text-end');

        if (idx === 9){
          // editable transporte
          td.innerHTML = `<input class="form-control form-control-sm text-end" value="${(r['Transporte'] ?? '').toString().replace('.',',')}" placeholder="0,00" data-row="${r._idx}">`;
        } else {
          td.textContent = val;
        }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }

    // bind edits
    tbody.querySelectorAll('input[data-row]').forEach(inp=>{
      inp.addEventListener('input', (e)=>{
        const idx = parseInt(e.target.getAttribute('data-row'),10);
        rawRows[idx]['Transporte'] = e.target.value;
      });
    });

    // DataTable init/reinit
    if (dt) { dt.destroy(); }
    dt = $('#tbl').DataTable({
      pageLength: 25,
      order: [[10,'desc']],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-BR.json" }
    });
  }

  // ---------- CSV load ----------
  function loadCsvText(csvText){
    Papa.parse(csvText, {
      header: true,
      delimiter: ';',
      skipEmptyLines: true,
      complete: (res)=>{
        const rows = (res.data || []).filter(r => Object.keys(r).length > 1);
        rawRows = rows.map((r,i)=>({ ...r, _idx:i }));
        renderAll();
      },
      error: (err)=> alert("Erro ao ler CSV: " + err)
    });
  }

  document.getElementById('fileInput').addEventListener('change', (ev)=>{
    const f = ev.target.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      const text = e.target.result;
      saveLastCsv(text);
      loadCsvText(text);
    };
    reader.readAsText(f, 'utf-8');
  });

  document.getElementById('btnLoadSample').addEventListener('click', ()=>{
    const last = loadLastCsv();
    if (!last) { alert("Nenhum arquivo salvo ainda. Importe um CSV primeiro."); return; }
    loadCsvText(last);
  });

  document.getElementById('selTopN').addEventListener('change', ()=> renderTopCosts());

  document.getElementById('btnRecalc').addEventListener('click', ()=>{
    // update transporte from inputs (in case DataTables redraw)
    document.querySelectorAll('input[data-row]').forEach(inp=>{
      const idx = parseInt(inp.getAttribute('data-row'),10);
      rawRows[idx]['Transporte'] = inp.value;
    });
    renderAll();
  });

  document.getElementById('btnDownload').addEventListener('click', ()=>{
    if (!rawRows.length) { alert("Importe um CSV primeiro."); return; }
    const cols = ['Colaborador','VÃ­nculo','Bruto MÃªs','FGTS','INSS Empresa','RAT','Terceiros','AlimentaÃ§Ã£o','Unimed','Transporte','Custo Total'];
    const lines = [cols.join(';')];
    rawRows.forEach(r=>{
      const total = computeRowCost(r);
      const row = { ...r, 'Custo Total': total.toFixed(2).replace('.',',') };
      const line = cols.map(c=>{
        let v = row[c];
        if (v === null || v === undefined) v = '';
        return String(v).replaceAll('\n',' ').trim();
      }).join(';');
      lines.push(line);
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'rh_custo_forca_trabalho_atualizado.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Auto-load last CSV if exists
  // ðŸ”¹ Auto-load: tenta carregar o CSV padrÃ£o do GitHub.
// Se nÃ£o existir, usa o Ãºltimo CSV salvo no navegador.
fetch('dados_atual.csv')
  .then(res => {
    if (!res.ok) throw new Error('CSV padrÃ£o nÃ£o encontrado');
    return res.text();
  })
  .then(csvText => {
    saveLastCsv(csvText);
    loadCsvText(csvText);
  })
  .catch(() => {
    const last = loadLastCsv();
    if (last) loadCsvText(last);
  });

</script>
</body>
</html>


